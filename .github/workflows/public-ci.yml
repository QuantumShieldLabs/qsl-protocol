name: public-ci

on:
  push:
    branches: [ "main" ]
  pull_request:

permissions:
  contents: read

jobs:
  public-safety:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: PR changed files (audit)
        if: github.event_name == 'pull_request'
        shell: bash
        run: |
          set -euo pipefail
          echo "Base: ${{ github.event.pull_request.base.sha }}"
          echo "Head: ${{ github.event.pull_request.head.sha }}"
          git diff --name-only "${{ github.event.pull_request.base.sha }}" "${{ github.event.pull_request.head.sha }}" | LC_ALL=C sort

      - name: Denylist filename scan
        shell: bash
        run: |
          set -euo pipefail
          HITS="$(find . -type f \( -name '.env' -o -name '*.pem' -o -name '*.key' -o -name '*.p12' \) -print | wc -l | tr -d ' ')"
          echo "DENY_HITS_FILES=$HITS"
          if [ "$HITS" != "0" ]; then
            echo "ERROR: denylist filenames detected:"
            find . -type f \( -name '.env' -o -name '*.pem' -o -name '*.key' -o -name '*.p12' \) -print
            exit 2
          fi

      - name: High-confidence credential content scan
        shell: bash
        run: |
          set -euo pipefail
          # Avoid generic words; match only high-confidence key/token patterns.
          grep -R -n -E \
            "(-----BEGIN (OPENSSH |RSA |EC |DSA )?PRIVATE KEY-----|-----BEGIN PRIVATE KEY-----|BEGIN OPENSSH PRIVATE KEY|AKIA[0-9A-Z]{16}|ASIA[0-9A-Z]{16}|ghp_[A-Za-z0-9]{36}|github_pat_[A-Za-z0-9_]{20,}|glpat-[A-Za-z0-9_-]{20,}|xox[baprs]-[A-Za-z0-9-]{10,}|AIza[0-9A-Za-z_-]{35}|ya29\.[0-9A-Za-z_-]+|Authorization:[[:space:]]*Bearer[[:space:]]+[A-Za-z0-9_.=\-]{10,}|x-api-key[[:space:]]*[:=][[:space:]]*[A-Za-z0-9_-]{10,})" \
            docs inputs README.md LICENSE SECURITY.md CONTRIBUTING.md THIRD_PARTY_NOTICES.md CODE_OF_CONDUCT.md SUPPORT.md DECISIONS.md TRACEABILITY.md NEXT_ACTIONS.md \
            > /tmp/highconf_hits.txt || true

          CNT="$(wc -l < /tmp/highconf_hits.txt | tr -d ' ')"
          echo "HC_COUNT=$CNT"
          if [ "$CNT" != "0" ]; then
            echo "ERROR: high-confidence credential hits detected (showing first 200 lines):"
            sed -n '1,200p' /tmp/highconf_hits.txt
            exit 2
          fi

      - name: Vector JSON parse sanity
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import json
          import glob
          import sys

          files = sorted(glob.glob('inputs/suite2/vectors/*.json'))
          if not files:
              print('ERROR: no vector JSON files found under inputs/suite2/vectors')
              sys.exit(2)

          for path in files:
              with open(path, 'r', encoding='utf-8') as f:
                  json.load(f)
          print(f'Parsed {len(files)} vector JSON files successfully.')
          PY

      - name: Markdown link check (relative links)
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import os
          import re
          import sys
          from pathlib import Path

          def strip_code_blocks(text: str) -> str:
              return re.sub(r"```.*?```", "", text, flags=re.S)

          md_files = [Path("README.md")] + list(Path("docs").rglob("*.md"))
          missing = []

          link_re = re.compile(r"\[([^\]]+)\]\(([^)]+)\)")
          for md in md_files:
              if not md.exists():
                  continue
              content = md.read_text(encoding="utf-8")
              content = strip_code_blocks(content)
              for _, target in link_re.findall(content):
                  if target.startswith(("http://", "https://", "mailto:")):
                      continue
                  target = target.split("#", 1)[0].strip()
                  if not target:
                      continue
                  if target.startswith("/"):
                      candidate = Path(target.lstrip("/"))
                  else:
                      candidate = (md.parent / target).resolve()
                  if not candidate.exists():
                      missing.append(f"{md}:{target}")

          if missing:
              print("ERROR: broken relative markdown links detected:")
              for item in missing:
                  print(item)
              sys.exit(2)
          print(f"Checked {len(md_files)} markdown files; no broken relative links.")
          PY

      - name: Vector JSON structure sanity
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import json
          import glob
          import sys

          files = sorted(glob.glob('inputs/suite2/vectors/*.json'))
          if not files:
              print('ERROR: no vector JSON files found under inputs/suite2/vectors')
              sys.exit(2)

          obj_count = 0
          array_count = 0
          for path in files:
              with open(path, 'r', encoding='utf-8') as f:
                  data = json.load(f)
              if data is None:
                  print(f"ERROR: {path} is empty/null")
                  sys.exit(2)
              if isinstance(data, list):
                  if not data:
                      print(f"ERROR: {path} is an empty array")
                      sys.exit(2)
                  array_count += 1
                  continue
              if isinstance(data, dict):
                  obj_count += 1
                  if not any(k in data for k in ("cases", "vectors", "tests")):
                      print(f"ERROR: {path} missing top-level cases/vectors/tests")
                      sys.exit(2)
                  if all(not data.get(k) for k in ("cases", "vectors", "tests")):
                      print(f"ERROR: {path} has empty cases/vectors/tests")
                      sys.exit(2)
                  continue
              print(f"ERROR: {path} is not an object or array")
              sys.exit(2)

          print(f"Vector structure OK. objects={obj_count} arrays={array_count}")
          PY

  advisories:
    name: advisories
    runs-on: ubuntu-latest
    env:
    steps:
      - uses: actions/checkout@v4

      - name: Set Rust toolchain (pinned)
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.84.0

      - name: Install cargo-binstall (compile, pinned)
        shell: bash
        run: |
          set -euo pipefail
          rustc --version
          cargo --version
          cargo install cargo-binstall --locked --version 1.10.0

      - name: Install cargo-audit (via binstall)
        shell: bash
        run: |
          set -euo pipefail
          cargo binstall cargo-audit --version 0.22.0 --no-confirm
          cargo audit --version || true

      - name: Cargo audit (fail-closed)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p advisories
          # Run audit; if it fails due to CVSS4 parser incompatibility, keep output for diagnosis.
          # TEMP: RustSec DB pin fallback for CVSS 4.0 parser incompatibility (remove when cargo-audit fully supports CVSS4).
          set +e
          cargo audit --deny warnings 2>&1 | tee advisories/audit_output.txt
          rc=${PIPESTATUS[0]}
          set -e
          if [ "$rc" -ne 0 ]; then

          echo "== audit_output.txt (first 200 lines) =="
          sed -n '1,200p' advisories/audit_output.txt || true

      - name: Upload advisories audit output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: advisories-audit-output
          path: advisories/audit_output.txt

