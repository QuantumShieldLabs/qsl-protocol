name: relay-ui-integration

on:
  workflow_dispatch:
  schedule:
    - cron: '25 2 * * *'

jobs:
  relay-ui-integration:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout qsl-protocol
        uses: actions/checkout@v4

      - name: Clone qsl-server outside workspace
        run: |
          set -euo pipefail
          git clone --depth 1 https://github.com/QuantumShieldLabs/qsl-server.git "$RUNNER_TEMP/qsl-server"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Build qsl-server binary
        working-directory: ${{ runner.temp }}/qsl-server
        run: cargo build --release --locked

      - name: Start local relay and run ignored relay UI integration tests
        env:
          QSC_RELAY_UI_PORT: "17777"
        run: |
          set -euo pipefail

          ARTIFACT_DIR="$GITHUB_WORKSPACE/artifacts"
          mkdir -p "$ARTIFACT_DIR"
          RELAY_URL="http://127.0.0.1:${QSC_RELAY_UI_PORT}"
          RELAY_TOKEN="$(openssl rand -hex 16)"
          echo "::add-mask::$RELAY_TOKEN"

          "$RUNNER_TEMP/qsl-server/target/release/qsl-server" \
            --bind 127.0.0.1 \
            --port "${QSC_RELAY_UI_PORT}" \
            > "$ARTIFACT_DIR/relay-server.log" 2>&1 &
          RELAY_PID=$!

          cleanup() {
            kill "$RELAY_PID" 2>/dev/null || true
            wait "$RELAY_PID" 2>/dev/null || true
          }
          trap cleanup EXIT

          # Readiness probe via TCP port open (no endpoint assumptions).
          for i in $(seq 1 40); do
            if (echo >"/dev/tcp/127.0.0.1/${QSC_RELAY_UI_PORT}") >/dev/null 2>&1; then
              break
            fi
            sleep 1
          done

          if ! (echo >"/dev/tcp/127.0.0.1/${QSC_RELAY_UI_PORT}") >/dev/null 2>&1; then
            echo "relay failed to bind on ${QSC_RELAY_UI_PORT}" >&2
            exit 1
          fi

          curl -fsS \
            -H "Authorization: Bearer ${RELAY_TOKEN}" \
            -X POST \
            --data-binary "ready" \
            "${RELAY_URL}/v1/push/health" >/dev/null
          curl -fsS \
            -H "Authorization: Bearer ${RELAY_TOKEN}" \
            "${RELAY_URL}/v1/pull/health?max=1" >/dev/null

          QSC_RELAY_UI_URL="${RELAY_URL}" \
          QSC_RELAY_UI_TOKEN="$RELAY_TOKEN" \
          cargo test -p qsc --test relay_ui_integration -- --ignored --nocapture \
            | tee "$ARTIFACT_DIR/relay-ui-integration.log"

      - name: Upload relay UI integration artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: relay-ui-integration-artifacts
          path: |
            artifacts/relay-server.log
            artifacts/relay-ui-integration.log
