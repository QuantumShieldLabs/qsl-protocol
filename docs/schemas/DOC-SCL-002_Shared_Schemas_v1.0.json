{
  "$defs": {
    "Base64Url": {
      "description": "Base64url without padding (RFC 4648 URL-safe; no '='). Represents raw bytes.",
      "minLength": 1,
      "pattern": "^[A-Za-z0-9_-]*$",
      "type": "string"
    },
    "Base64UrlOptional": {
      "description": "Base64url without padding; empty string allowed where documented.",
      "minLength": 0,
      "pattern": "^[A-Za-z0-9_-]*$",
      "type": "string"
    },
    "ErrorResponse": {
      "additionalProperties": false,
      "properties": {
        "details": {
          "additionalProperties": true,
          "description": "Optional sanitized diagnostic detail (no secrets, no raw identifiers).",
          "type": "object"
        },
        "error_code": {
          "$ref": "#/$defs/ReasonCode"
        },
        "message": {
          "description": "Sanitized human-readable message; MUST NOT include secrets or raw route_token values.",
          "maxLength": 512,
          "minLength": 1,
          "type": "string"
        },
        "retryable": {
          "type": "boolean"
        }
      },
      "required": [
        "error_code",
        "message",
        "retryable"
      ],
      "type": "object"
    },
    "FixedBytes16B64": {
      "allOf": [
        {
          "$ref": "#/$defs/Base64Url"
        }
      ],
      "description": "base64url encoding of exactly 16 bytes (decoded length must be enforced by implementation)."
    },
    "FixedBytes32B64": {
      "allOf": [
        {
          "$ref": "#/$defs/Base64Url"
        }
      ],
      "description": "base64url encoding of exactly 32 bytes (decoded length must be enforced by implementation)."
    },
    "IdempotencyKey": {
      "description": "Caller-supplied key to make retries safe (idempotent) within a server-defined window.",
      "maxLength": 128,
      "minLength": 8,
      "type": "string"
    },
    "KtlAppendRequest": {
      "additionalProperties": false,
      "properties": {
        "idempotency_key": {
          "$ref": "#/$defs/IdempotencyKey"
        },
        "leaf_data_b64": {
          "$ref": "#/$defs/Base64Url",
          "description": "Canonical leaf binding bytes per KT profile."
        }
      },
      "required": [
        "leaf_data_b64",
        "idempotency_key"
      ],
      "type": "object"
    },
    "KtlAppendResponse": {
      "additionalProperties": false,
      "properties": {
        "inclusion_proof_b64": {
          "$ref": "#/$defs/Base64Url"
        },
        "sth_b64": {
          "$ref": "#/$defs/Base64Url"
        }
      },
      "required": [
        "sth_b64",
        "inclusion_proof_b64"
      ],
      "type": "object"
    },
    "KtlConsistencyProofRequest": {
      "additionalProperties": false,
      "properties": {
        "from_tree_size": {
          "minimum": 0,
          "type": "integer"
        },
        "to_tree_size": {
          "minimum": 0,
          "type": "integer"
        }
      },
      "required": [
        "from_tree_size"
      ],
      "type": "object"
    },
    "KtlConsistencyProofResponse": {
      "additionalProperties": false,
      "properties": {
        "consistency_proof_b64": {
          "$ref": "#/$defs/Base64Url",
          "description": "Canonical consistency proof encoding."
        },
        "to_sth_b64": {
          "$ref": "#/$defs/Base64Url"
        }
      },
      "required": [
        "to_sth_b64",
        "consistency_proof_b64"
      ],
      "type": "object"
    },
    "KtlGetSthResponse": {
      "additionalProperties": false,
      "properties": {
        "cache_ttl_seconds": {
          "minimum": 0,
          "type": "integer"
        },
        "sth_b64": {
          "$ref": "#/$defs/Base64Url",
          "description": "Canonical STH bytes per KT profile."
        }
      },
      "required": [
        "sth_b64"
      ],
      "type": "object"
    },
    "KtlInclusionProofRequest": {
      "additionalProperties": false,
      "properties": {
        "leaf_hash_b64": {
          "$ref": "#/$defs/FixedBytes32B64"
        },
        "tree_size": {
          "minimum": 0,
          "type": "integer"
        }
      },
      "required": [
        "leaf_hash_b64"
      ],
      "type": "object"
    },
    "KtlInclusionProofResponse": {
      "additionalProperties": false,
      "properties": {
        "inclusion_proof_b64": {
          "$ref": "#/$defs/Base64Url",
          "description": "Canonical inclusion proof encoding."
        },
        "sth_b64": {
          "$ref": "#/$defs/Base64Url"
        }
      },
      "required": [
        "sth_b64",
        "inclusion_proof_b64"
      ],
      "type": "object"
    },
    "OpaqueHandle": {
      "description": "Opaque handle generated by a service (msg_handle, cursor, bundle_id, etc.).",
      "maxLength": 256,
      "minLength": 1,
      "type": "string"
    },
    "PdsBundleItem": {
      "additionalProperties": false,
      "properties": {
        "bundle_id": {
          "$ref": "#/$defs/OpaqueHandle"
        },
        "device_id": {
          "maximum": 4294967295,
          "minimum": 0,
          "type": "integer"
        },
        "expires_at": {
          "$ref": "#/$defs/TimestampRfc3339"
        },
        "prekey_bundle_b64": {
          "$ref": "#/$defs/Base64Url",
          "description": "Canonical QSP PrekeyBundle bytes."
        },
        "served_opk": {
          "additionalProperties": false,
          "properties": {
            "dh_opk_id": {
              "maximum": 4294967295,
              "minimum": 0,
              "type": "integer"
            },
            "pq_opk_id": {
              "maximum": 4294967295,
              "minimum": 0,
              "type": "integer"
            }
          },
          "type": "object"
        }
      },
      "required": [
        "device_id",
        "bundle_id",
        "prekey_bundle_b64"
      ],
      "type": "object"
    },
    "PdsGetBundlesResponse": {
      "additionalProperties": false,
      "properties": {
        "bundles": {
          "items": {
            "$ref": "#/$defs/PdsBundleItem"
          },
          "type": "array"
        },
        "sth_hint": {
          "additionalProperties": false,
          "properties": {
            "kt_log_id_b64": {
              "$ref": "#/$defs/Base64Url"
            },
            "sth_b64": {
              "$ref": "#/$defs/Base64UrlOptional"
            }
          },
          "type": "object"
        },
        "user_handle": {
          "type": "string"
        }
      },
      "required": [
        "user_handle",
        "bundles"
      ],
      "type": "object"
    },
    "PdsOpkBatchUploadDhRequest": {
      "additionalProperties": false,
      "properties": {
        "idempotency_key": {
          "$ref": "#/$defs/IdempotencyKey"
        },
        "items": {
          "items": {
            "$ref": "#/$defs/PdsOpkDhItem"
          },
          "maxItems": 5000,
          "minItems": 1,
          "type": "array"
        }
      },
      "required": [
        "items",
        "idempotency_key"
      ],
      "type": "object"
    },
    "PdsOpkBatchUploadPqRequest": {
      "additionalProperties": false,
      "properties": {
        "idempotency_key": {
          "$ref": "#/$defs/IdempotencyKey"
        },
        "items": {
          "items": {
            "$ref": "#/$defs/PdsOpkPqItem"
          },
          "maxItems": 5000,
          "minItems": 1,
          "type": "array"
        }
      },
      "required": [
        "items",
        "idempotency_key"
      ],
      "type": "object"
    },
    "PdsOpkBatchUploadResponse": {
      "additionalProperties": false,
      "properties": {
        "accepted": {
          "minimum": 0,
          "type": "integer"
        },
        "reject_reasons": {
          "items": {
            "additionalProperties": false,
            "properties": {
              "error_code": {
                "$ref": "#/$defs/ReasonCode"
              },
              "opk_id": {
                "maximum": 4294967295,
                "minimum": 0,
                "type": "integer"
              }
            },
            "required": [
              "opk_id",
              "error_code"
            ],
            "type": "object"
          },
          "type": "array"
        },
        "rejected": {
          "minimum": 0,
          "type": "integer"
        }
      },
      "required": [
        "accepted",
        "rejected"
      ],
      "type": "object"
    },
    "PdsOpkDhItem": {
      "additionalProperties": false,
      "properties": {
        "opk_id": {
          "maximum": 4294967295,
          "minimum": 0,
          "type": "integer"
        },
        "opk_pub_b64": {
          "$ref": "#/$defs/Base64Url",
          "description": "DH OPK public key bytes (expected 32 bytes for Suite-1/Suite-1B)."
        }
      },
      "required": [
        "opk_id",
        "opk_pub_b64"
      ],
      "type": "object"
    },
    "PdsOpkInventoryResponse": {
      "additionalProperties": false,
      "properties": {
        "dh_available_bucket": {
          "type": "string"
        },
        "last_upload_at": {
          "$ref": "#/$defs/TimestampRfc3339"
        },
        "pq_available_bucket": {
          "type": "string"
        }
      },
      "required": [
        "dh_available_bucket",
        "pq_available_bucket"
      ],
      "type": "object"
    },
    "PdsOpkPqItem": {
      "additionalProperties": false,
      "properties": {
        "opk_id": {
          "maximum": 4294967295,
          "minimum": 0,
          "type": "integer"
        },
        "opk_pub_b64": {
          "$ref": "#/$defs/Base64Url",
          "description": "PQ OPK public key bytes (suite-defined size)."
        }
      },
      "required": [
        "opk_id",
        "opk_pub_b64"
      ],
      "type": "object"
    },
    "PdsPutBundleRequest": {
      "additionalProperties": false,
      "properties": {
        "bundle_fields_b64": {
          "$ref": "#/$defs/Base64Url",
          "description": "Canonical bytes of bundle fields covered by signatures."
        },
        "bundle_format": {
          "description": "Identifier for canonical bundle format (e.g., 'QSP-4.3.2').",
          "maxLength": 32,
          "minLength": 1,
          "type": "string"
        },
        "idempotency_key": {
          "$ref": "#/$defs/IdempotencyKey"
        },
        "if_revision": {
          "description": "Optional optimistic concurrency guard.",
          "minimum": 0,
          "type": "integer"
        },
        "kt_log_id_b64": {
          "$ref": "#/$defs/Base64UrlOptional",
          "description": "Optional preferred KT log_id (base64url(32))."
        },
        "sig_ec_b64": {
          "$ref": "#/$defs/Base64Url",
          "description": "EC signature bytes (suite-defined)."
        },
        "sig_pq_b64": {
          "$ref": "#/$defs/Base64UrlOptional",
          "description": "PQ signature bytes; empty string allowed when not applicable."
        },
        "valid_from": {
          "oneOf": [
            {
              "minimum": 0,
              "type": "integer"
            },
            {
              "format": "date-time",
              "type": "string"
            }
          ]
        },
        "valid_to": {
          "oneOf": [
            {
              "minimum": 0,
              "type": "integer"
            },
            {
              "format": "date-time",
              "type": "string"
            }
          ]
        }
      },
      "required": [
        "bundle_format",
        "bundle_fields_b64",
        "sig_ec_b64",
        "valid_from",
        "valid_to",
        "idempotency_key"
      ],
      "type": "object"
    },
    "PdsPutBundleResponse": {
      "additionalProperties": false,
      "properties": {
        "bundle_id": {
          "$ref": "#/$defs/OpaqueHandle"
        },
        "bundle_revision": {
          "minimum": 0,
          "type": "integer"
        },
        "status": {
          "enum": [
            "active"
          ],
          "type": "string"
        },
        "warnings": {
          "items": {
            "maxLength": 256,
            "type": "string"
          },
          "type": "array"
        }
      },
      "required": [
        "bundle_id",
        "bundle_revision",
        "status"
      ],
      "type": "object"
    },
    "PdsRevokeRequest": {
      "additionalProperties": false,
      "properties": {
        "idempotency_key": {
          "$ref": "#/$defs/IdempotencyKey"
        },
        "reason_code": {
          "maxLength": 64,
          "type": "string"
        }
      },
      "required": [
        "idempotency_key"
      ],
      "type": "object"
    },
    "PdsRevokeResponse": {
      "additionalProperties": false,
      "properties": {
        "revoked_at": {
          "$ref": "#/$defs/TimestampRfc3339"
        },
        "status": {
          "enum": [
            "revoked"
          ],
          "type": "string"
        }
      },
      "required": [
        "status",
        "revoked_at"
      ],
      "type": "object"
    },
    "ReasonCode": {
      "description": "Standardized sanitized reason code.",
      "enum": [
        "noncanonical_qse",
        "bounds_exceeded",
        "invalid_request",
        "rate_limited",
        "queue_full",
        "auth_failed",
        "forbidden",
        "not_found",
        "conflict",
        "opk_unavailable",
        "server_error",
        "kt_fail",
        "bundle_sig_fail",
        "aead_fail",
        "replay",
        "policy_reject"
      ],
      "type": "string"
    },
    "RsfAckRequest": {
      "additionalProperties": false,
      "properties": {
        "acks": {
          "items": {
            "$ref": "#/$defs/OpaqueHandle"
          },
          "maxItems": 500,
          "minItems": 1,
          "type": "array"
        },
        "route_token_b64": {
          "$ref": "#/$defs/Base64Url"
        }
      },
      "required": [
        "route_token_b64",
        "acks"
      ],
      "type": "object"
    },
    "RsfAckResponse": {
      "additionalProperties": false,
      "properties": {
        "acked": {
          "minimum": 0,
          "type": "integer"
        },
        "errors": {
          "items": {
            "additionalProperties": false,
            "properties": {
              "error_code": {
                "$ref": "#/$defs/ReasonCode"
              },
              "msg_handle": {
                "$ref": "#/$defs/OpaqueHandle"
              }
            },
            "required": [
              "msg_handle",
              "error_code"
            ],
            "type": "object"
          },
          "type": "array"
        },
        "not_found": {
          "minimum": 0,
          "type": "integer"
        }
      },
      "required": [
        "acked",
        "not_found"
      ],
      "type": "object"
    },
    "RsfEnqueueRequest": {
      "additionalProperties": false,
      "properties": {
        "idempotency_key": {
          "$ref": "#/$defs/IdempotencyKey"
        },
        "priority": {
          "default": "normal",
          "enum": [
            "normal",
            "high"
          ],
          "type": "string"
        },
        "qse_envelope_b64": {
          "$ref": "#/$defs/Base64Url",
          "description": "Canonical QSE envelope bytes."
        }
      },
      "required": [
        "qse_envelope_b64"
      ],
      "type": "object"
    },
    "RsfEnqueueResponse": {
      "additionalProperties": false,
      "properties": {
        "accepted": {
          "type": "boolean"
        },
        "inbox_hint": {
          "additionalProperties": false,
          "properties": {
            "approx_queue_depth_bucket": {
              "type": "string"
            }
          },
          "type": "object"
        },
        "msg_handle": {
          "$ref": "#/$defs/OpaqueHandle",
          "description": "Present if accepted."
        },
        "queued_at": {
          "$ref": "#/$defs/TimestampRfc3339"
        },
        "reject_reason": {
          "$ref": "#/$defs/ReasonCode",
          "description": "Present if accepted=false."
        }
      },
      "required": [
        "accepted",
        "queued_at"
      ],
      "type": "object"
    },
    "RsfFetchItem": {
      "additionalProperties": false,
      "properties": {
        "msg_handle": {
          "$ref": "#/$defs/OpaqueHandle"
        },
        "qse_envelope_b64": {
          "$ref": "#/$defs/Base64Url",
          "description": "Canonical QSE envelope bytes."
        },
        "queued_at": {
          "$ref": "#/$defs/TimestampRfc3339"
        }
      },
      "required": [
        "msg_handle",
        "qse_envelope_b64",
        "queued_at"
      ],
      "type": "object"
    },
    "RsfFetchRequest": {
      "additionalProperties": false,
      "properties": {
        "client_cursor": {
          "$ref": "#/$defs/OpaqueHandle"
        },
        "max_bytes": {
          "default": 262144,
          "maximum": 1048576,
          "minimum": 65536,
          "type": "integer"
        },
        "max_items": {
          "default": 20,
          "maximum": 200,
          "minimum": 1,
          "type": "integer"
        },
        "route_token_b64": {
          "$ref": "#/$defs/Base64Url",
          "description": "base64url bytes of route_token (opaque)."
        },
        "visibility_timeout_seconds": {
          "default": 0,
          "maximum": 600,
          "minimum": 0,
          "type": "integer"
        },
        "wait_seconds": {
          "default": 0,
          "maximum": 60,
          "minimum": 0,
          "type": "integer"
        }
      },
      "required": [
        "route_token_b64"
      ],
      "type": "object"
    },
    "RsfFetchResponse": {
      "additionalProperties": false,
      "properties": {
        "items": {
          "items": {
            "$ref": "#/$defs/RsfFetchItem"
          },
          "type": "array"
        },
        "lease_expires_at": {
          "$ref": "#/$defs/TimestampRfc3339"
        },
        "next_cursor": {
          "$ref": "#/$defs/OpaqueHandle"
        }
      },
      "required": [
        "items"
      ],
      "type": "object"
    },
    "RsfNackRequest": {
      "additionalProperties": false,
      "properties": {
        "msg_handles": {
          "items": {
            "$ref": "#/$defs/OpaqueHandle"
          },
          "maxItems": 500,
          "minItems": 1,
          "type": "array"
        },
        "route_token_b64": {
          "$ref": "#/$defs/Base64Url"
        }
      },
      "required": [
        "route_token_b64",
        "msg_handles"
      ],
      "type": "object"
    },
    "RsfNackResponse": {
      "additionalProperties": false,
      "properties": {
        "released": {
          "minimum": 0,
          "type": "integer"
        }
      },
      "required": [
        "released"
      ],
      "type": "object"
    },
    "RsfRouteTokenRegisterRequest": {
      "additionalProperties": false,
      "properties": {
        "idempotency_key": {
          "$ref": "#/$defs/IdempotencyKey"
        },
        "route_token_b64": {
          "$ref": "#/$defs/Base64Url"
        }
      },
      "required": [
        "route_token_b64"
      ],
      "type": "object"
    },
    "RsfRouteTokenRegisterResponse": {
      "additionalProperties": false,
      "properties": {
        "effective_at": {
          "$ref": "#/$defs/TimestampRfc3339"
        },
        "registered": {
          "type": "boolean"
        }
      },
      "required": [
        "registered",
        "effective_at"
      ],
      "type": "object"
    },
    "RsfRouteTokenRotateRequest": {
      "additionalProperties": false,
      "properties": {
        "idempotency_key": {
          "$ref": "#/$defs/IdempotencyKey"
        },
        "new_route_token_b64": {
          "$ref": "#/$defs/Base64Url"
        },
        "old_route_token_b64": {
          "$ref": "#/$defs/Base64Url"
        },
        "overlap_seconds": {
          "default": 86400,
          "maximum": 604800,
          "minimum": 0,
          "type": "integer"
        }
      },
      "required": [
        "old_route_token_b64",
        "new_route_token_b64"
      ],
      "type": "object"
    },
    "RsfRouteTokenRotateResponse": {
      "additionalProperties": false,
      "properties": {
        "effective_at": {
          "$ref": "#/$defs/TimestampRfc3339"
        },
        "overlap_expires_at": {
          "$ref": "#/$defs/TimestampRfc3339"
        },
        "rotated": {
          "type": "boolean"
        }
      },
      "required": [
        "rotated",
        "effective_at",
        "overlap_expires_at"
      ],
      "type": "object"
    },
    "RsfStatusRequest": {
      "additionalProperties": false,
      "properties": {
        "route_token_b64": {
          "$ref": "#/$defs/Base64Url"
        }
      },
      "required": [
        "route_token_b64"
      ],
      "type": "object"
    },
    "RsfStatusResponse": {
      "additionalProperties": false,
      "properties": {
        "oldest_item_age_bucket": {
          "type": "string"
        },
        "policy": {
          "additionalProperties": false,
          "properties": {
            "max_items": {
              "minimum": 0,
              "type": "integer"
            },
            "ttl_days": {
              "minimum": 0,
              "type": "integer"
            }
          },
          "type": "object"
        },
        "queue_bytes_bucket": {
          "type": "string"
        },
        "queue_depth_bucket": {
          "type": "string"
        }
      },
      "required": [
        "queue_depth_bucket",
        "queue_bytes_bucket",
        "oldest_item_age_bucket"
      ],
      "type": "object"
    },
    "TimestampRfc3339": {
      "description": "RFC3339 timestamp (server-provided; coarse timestamps recommended for privacy).",
      "format": "date-time",
      "type": "string"
    }
  },
  "$id": "qshield://schemas/shared/DOC-SCL-002/v1.0",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "description": "Machine-readable JSON Schemas referenced by QuantumShield service contracts and tooling. Companion to DOC-SCL-002.",
  "title": "QuantumShield Shared Schemas (DOC-SCL-002 v1.0)",
  "type": "object"
}